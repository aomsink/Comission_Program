<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: "Kanit", sans-serif; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
    }

    .card {
        width: 80%;
        max-width: 1100px;
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 10px 45px rgba(0, 0, 0, 0.2);
        padding: 35px;
        animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
        from {opacity: 0; transform: translateY(15px);}
        to {opacity: 1; transform: translateY(0);}
    }

    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .back-btn {
        font-size: 28px;
        cursor: pointer;
        color: #222;
        transition: transform 0.2s;
    }
    
    .back-btn:hover {
        transform: translateX(-3px);
    }

    h1 {
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }

    .sort-box select {
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid #ddd;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        font-family: "Kanit", sans-serif;
        font-size: 14px;
        cursor: pointer;
        outline: none;
    }

    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        font-size: 15px;
    }

    th, td {
        padding: 14px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        font-weight: 600;
        color: #333;
        background-color: #f9f9f9;
        border-radius: 8px 8px 0 0; /* ‡∏°‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
    }
    
    tr:last-child td {
        border-bottom: none;
    }
</style>
</head>
<body>

<div class="card">
    <div class="header">
        <div class="back-btn" onclick="goBack()">‚Üê</div>
        <h1>üí∞ Commission Calculator</h1>

        <div class="sort-box">
            <select id="sortSelect" onchange="applySort()">
                <option value="date_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</option>
                <option value="date_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î)</option>
                <option value="name">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ (‡∏Å-‡∏Æ / A-Z)</option>
                <option value="sales_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏°‡∏≤‡∏Å-‡∏ô‡πâ‡∏≠‡∏¢)</option>
                <option value="commission_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (‡∏°‡∏≤‡∏Å-‡∏ô‡πâ‡∏≠‡∏¢)</option>
            </select>
        </div>
    </div>

    <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h2>

    <table id="historyTable">
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>locks</th>
                <th>stocks</th>
                <th>barrels</th>
                <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                <th>‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
</div>

<script>
    // 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô Sort
    let globalData = [];

    async function loadHistory() {
        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
            const res = await fetch('http://localhost:3000/api/commissions/history');
            const result = await res.json();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ API ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô {data: [...]})
            if (result.data) {
                globalData = result.data;
            } else if (Array.isArray(result)) {
                globalData = result;
            } else {
                globalData = [];
            }
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
            applySort();

        } catch (err) {
            console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
            document.getElementById('historyBody').innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ</td></tr>`;
        }
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)
    function renderTable(data) {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = "";

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`;
            return;
        }

        data.forEach(item => {
            const dateObj = new Date(item.created_at);
            const formattedDate = dateObj.toLocaleDateString("en-US", {
                month: "2-digit",
                day: "2-digit",
                year: "numeric",
                hour: "2-digit", 
                minute: "2-digit"
            });

            const row = `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.locks}</td>
                    <td>${item.stocks}</td>
                    <td>${item.barrels}</td>
                    <td>$${Number(item.sales).toLocaleString()}</td>
                    <td>$${Number(item.commission).toLocaleString()}</td>
                    <td>${formattedDate}</td>
                </tr>`;
            tbody.innerHTML += row;
        });
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà)
    function applySort() {
        const sortType = document.getElementById("sortSelect").value;
        
        // Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        let sortedData = [...globalData];

        switch(sortType) {
            case 'date_desc': // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                sortedData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
            case 'date_asc': // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
                sortedData.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                break;
            case 'name': // ‡∏ä‡∏∑‡πà‡∏≠
                sortedData.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'sales_desc': // ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡∏°‡∏≤‡∏Å->‡∏ô‡πâ‡∏≠‡∏¢
                sortedData.sort((a, b) => b.sales - a.sales);
                break;
            case 'commission_desc': // ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ‡∏°‡∏≤‡∏Å->‡∏ô‡πâ‡∏≠‡∏¢
                sortedData.sort((a, b) => b.commission - a.commission);
                break;
        }

        // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
        renderTable(sortedData);
    }

    function goBack() {
        window.location.href = "/";
    }

    loadHistory();
</script>

</body>
</html>